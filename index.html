<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR 簽到退系統 (Firebase 修正版)</title>
    
    <!-- 1. 載入 Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 React 核心 (與舊版不同，這裡確保載入順序) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. 載入 Babel (讓瀏覽器看不懂 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 修正說明：已移除 lucide-react 外部連結，徹底解決 forwardRef 錯誤 -->

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <!-- 4. 主程式邏輯 (type="text/babel" data-type="module" 是關鍵) -->
    <script type="text/babel" data-type="module">
        // 匯入 Firebase SDK (使用 ES Module 版本)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // 【請填入您的 Firebase 設定】
        // ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyAV5O4HjqCeW_h9q4VydGBkLnZkQM0y8BI",
  authDomain: "qr2026-1b0bf.firebaseapp.com",
  projectId: "qr2026-1b0bf",
  storageBucket: "qr2026-1b0bf.firebasestorage.app",
  messagingSenderId: "715858498670",
  appId: "1:715858498670:web:f51e33d7abce1fa504827f"
};

        // --- 初始化 Firebase ---
        let app, auth, db;
        let isConfigured = false;
        
        // 檢查使用者是否已填入設定
        if (firebaseConfig.apiKey !== "請填入_apiKey") {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isConfigured = true;
            } catch (e) {
                console.error("Firebase 初始化失敗:", e);
            }
        }

        const { useState, useEffect, useMemo } = React;

        // --- [關鍵修正] 內建 SVG 圖示元件 ---
        // 直接在這裡定義圖示，不依賴外部檔案，保證不會報錯
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            ClipboardList: (p) => <Icon {...p} path={<><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M9 12h6"/><path d="M9 16h6"/></>} />,
            LogIn: (p) => <Icon {...p} path={<><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></>} />,
            LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            CheckCircle2: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>} />,
            AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />,
            Trash2: (p) => <Icon {...p} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
        };

        // --- 主程式元件 ---
        function App() {
            const [user, setUser] = useState(null);
            const [viewMode, setViewMode] = useState('loading');
            const [workshopName, setWorkshopName] = useState('預設研習活動');
            const [logs, setLogs] = useState([]);
            const [urlWorkshop, setUrlWorkshop] = useState('');
            const [urlAction, setUrlAction] = useState('');

            useEffect(() => {
                if (!isConfigured) {
                    setViewMode('config_needed');
                    return;
                }
                const initAuth = async () => { try { await signInAnonymously(auth); } catch (e) { console.error(e); } };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) {
                        const params = new URLSearchParams(window.location.search);
                        const action = params.get('action');
                        const ws = params.get('workshop');
                        if (action && ws) {
                            setViewMode('student');
                            setUrlAction(action);
                            setUrlWorkshop(decodeURIComponent(ws));
                        } else {
                            setViewMode('admin');
                        }
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const q = query(collection(db, 'attendance_logs'), orderBy('timestamp', 'desc'));
                const unsubscribe = onSnapshot(q, (s) => {
                    setLogs(s.docs.map(d => ({ id: d.id, ...d.data(), timestamp: d.data().timestamp ? d.data().timestamp.toDate() : new Date() })));
                });
                return () => unsubscribe();
            }, [user]);

            const currentWorkshopLogs = useMemo(() => logs.filter(l => l.workshop === workshopName), [logs, workshopName]);
            const signedInUsers = useMemo(() => currentWorkshopLogs.filter(l => l.type === 'signin'), [currentWorkshopLogs]);
            const signedOutUsers = useMemo(() => currentWorkshopLogs.filter(l => l.type === 'signout'), [currentWorkshopLogs]);

            if (viewMode === 'config_needed') return <ConfigGuide />;
            if (viewMode === 'loading') return <div className="min-h-screen flex items-center justify-center text-gray-500">系統載入中...</div>;
            if (viewMode === 'student') return <StudentView workshop={urlWorkshop} action={urlAction} userId={user?.uid} />;

            return (
                <AdminDashboard 
                    workshopName={workshopName} 
                    setWorkshopName={setWorkshopName}
                    signedInUsers={signedInUsers}
                    signedOutUsers={signedOutUsers}
                    allLogs={currentWorkshopLogs}
                    logs={logs}
                />
            );
        }

        // --- 設定教學畫面 ---
        function ConfigGuide() {
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg max-w-2xl w-full border-l-4 border-red-500">
                        <h1 className="text-2xl font-bold text-red-600 mb-4 flex items-center gap-2"><Icons.AlertCircle className="w-8 h-8"/> 尚未設定 Firebase</h1>
                        <p className="text-gray-700 mb-4">請用記事本打開此 HTML 檔案，並填入您的 Firebase Config。</p>
                        <div className="bg-gray-100 p-4 rounded text-sm font-mono text-gray-600 mb-4">
                            const firebaseConfig = &#123;<br/>
                            &nbsp;&nbsp;apiKey: "...",<br/>
                            &nbsp;&nbsp;authDomain: "...",<br/>
                            &nbsp;&nbsp;...<br/>
                            &#125;;
                        </div>
                        <p className="text-sm text-gray-500">請參考下方的圖文教學取得這些代碼。</p>
                    </div>
                </div>
            );
        }

        // --- 管理者畫面 ---
        function AdminDashboard({ workshopName, setWorkshopName, signedInUsers, signedOutUsers, allLogs, logs }) {
            const [activeTab, setActiveTab] = useState('signin');
            const [isClearing, setIsClearing] = useState(false);
            
            const generateLink = (type) => {
                const baseUrl = window.location.href.split('?')[0];
                const params = new URLSearchParams();
                params.set('workshop', encodeURIComponent(workshopName));
                params.set('action', type);
                return `${baseUrl}?${params.toString()}`;
            };
            const currentLink = generateLink(activeTab);
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(currentLink)}`;

            const handleExport = () => {
                if(allLogs.length===0) return alert("無資料");
                const userMap = {};
                [...allLogs].sort((a,b)=>a.timestamp-b.timestamp).forEach(l=>{
                    if(!userMap[l.name]) userMap[l.name]={name:l.name,signin:null,signout:null,fb:''};
                    if(l.type==='signin' && !userMap[l.name].signin) userMap[l.name].signin=l.timestamp;
                    if(l.type==='signout') { userMap[l.name].signout=l.timestamp; if(l.feedback) userMap[l.name].fb=l.feedback; }
                });
                const BOM = "\uFEFF";
                const csv = Object.values(userMap).map(u=>
                    `"${u.name}","${u.signin?u.signin.toLocaleString('zh-TW'):'未簽到'}","${u.signout?u.signout.toLocaleString('zh-TW'):'未簽退'}","${(u.fb||'').replace(/"/g,'""')}"`
                ).join("\n");
                const link = document.createElement('a');
                link.href=URL.createObjectURL(new Blob([BOM+"姓名,簽到,簽退,回饋\n"+csv],{type:'text/csv;charset=utf-8;'}));
                link.download=`${workshopName}_總表.csv`;
                link.click();
            };

            const handleClear = async () => {
                if(!confirm(`確定刪除「${workshopName}」所有紀錄？`)) return;
                setIsClearing(true);
                try {
                    const batchSize=400; const targets=logs.filter(l=>l.workshop===workshopName);
                    for(let i=0;i<targets.length;i+=batchSize){
                        const b=writeBatch(db);
                        targets.slice(i,i+batchSize).forEach(l=>b.delete(doc(db,'attendance_logs',l.id)));
                        await b.commit();
                    }
                    alert("已清除");
                } catch(e){console.error(e);alert("清除失敗");} finally{setIsClearing(false);}
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-7xl mx-auto space-y-6">
                    <div className="bg-white rounded-xl shadow p-6 flex flex-col lg:flex-row justify-between items-center gap-6 border-l-4 border-blue-600">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><Icons.ClipboardList className="w-8 h-8 text-blue-600"/> 研習簽到系統 <span className="text-sm font-normal text-gray-500">(Firebase 版)</span></h1>
                        </div>
                        <div className="flex flex-col md:flex-row gap-4 w-full lg:w-auto">
                            <input value={workshopName} onChange={e=>setWorkshopName(e.target.value)} className="border rounded-lg px-4 py-2 w-full md:w-64 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="研習名稱"/>
                            <div className="flex gap-2">
                                <button onClick={handleExport} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 whitespace-nowrap"><Icons.Download className="w-4 h-4"/> 匯出</button>
                                <button onClick={handleClear} disabled={isClearing} className="flex items-center gap-2 px-4 py-2 bg-red-50 text-red-600 border border-red-200 rounded-lg hover:bg-red-100 whitespace-nowrap"><Icons.Trash2 className="w-4 h-4"/> 清除</button>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-1 space-y-6">
                            <div className="bg-white rounded-xl shadow p-6 text-center">
                                <div className="flex gap-2 mb-6 bg-gray-100 p-1 rounded-lg">
                                    <button onClick={()=>setActiveTab('signin')} className={`flex-1 py-2 rounded-md flex justify-center items-center gap-2 ${activeTab==='signin'?'bg-white text-blue-600 shadow-sm':'text-gray-500'}`}><Icons.LogIn className="w-4 h-4"/> 簽到QR</button>
                                    <button onClick={()=>setActiveTab('signout')} className={`flex-1 py-2 rounded-md flex justify-center items-center gap-2 ${activeTab==='signout'?'bg-white text-green-600 shadow-sm':'text-gray-500'}`}><Icons.LogOut className="w-4 h-4"/> 簽退QR</button>
                                </div>
                                <div className="border-2 border-gray-100 p-2 rounded-lg inline-block"><img src={qrCodeUrl} className="w-64 h-64 object-contain"/></div>
                                <div className="mt-8 grid grid-cols-2 gap-4">
                                    <div className="bg-blue-50 p-4 rounded-xl"><p className="text-blue-600 text-sm">已簽到</p><p className="text-3xl font-bold text-blue-800">{signedInUsers.length}</p></div>
                                    <div className="bg-green-50 p-4 rounded-xl"><p className="text-green-600 text-sm">已簽退</p><p className="text-3xl font-bold text-green-800">{signedOutUsers.length}</p></div>
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-2 bg-white rounded-xl shadow flex flex-col h-[600px]">
                            <div className="p-4 border-b flex justify-between items-center">
                                <h2 className="font-bold flex items-center gap-2">{activeTab==='logs'?<Icons.ClipboardList className="w-5 h-5"/>:<Icons.Users className="w-5 h-5"/>} {activeTab==='signin'?'簽到名單':activeTab==='signout'?'簽退名單':'完整紀錄'}</h2>
                                <button onClick={()=>setActiveTab('logs')} className={`text-sm px-3 py-1 rounded-full border ${activeTab==='logs'?'bg-gray-800 text-white':''}`}>完整紀錄</button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4">
                                {activeTab==='logs'?(
                                    <table className="w-full text-sm text-left text-gray-500">
                                        <thead className="bg-gray-50 sticky top-0"><tr><th className="px-4 py-2">時間</th><th className="px-4 py-2">姓名</th><th className="px-4 py-2">動作</th><th className="px-4 py-2">備註</th></tr></thead>
                                        <tbody>
                                            {allLogs.map(l=>(<tr key={l.id} className="border-b hover:bg-gray-50">
                                                <td className="px-4 py-2 font-mono text-xs">{l.timestamp.toLocaleTimeString('zh-TW')}</td>
                                                <td className="px-4 py-2">{l.name}</td>
                                                <td className="px-4 py-2"><span className={`px-2 py-1 rounded text-xs ${l.type==='signin'?'bg-blue-100 text-blue-800':'bg-green-100 text-green-800'}`}>{l.type==='signin'?'簽到':'簽退'}</span></td>
                                                <td className="px-4 py-2 truncate max-w-xs">{l.feedback||'-'}</td>
                                            </tr>))}
                                        </tbody>
                                    </table>
                                ):(
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        {(activeTab==='signin'?signedInUsers:signedOutUsers).map(u=>(
                                            <div key={u.id} className="flex items-center gap-3 p-3 rounded-lg border bg-gray-50 animate-fade-in">
                                                <div className={`w-8 h-8 rounded-full flex justify-center items-center text-white text-sm font-bold ${activeTab==='signin'?'bg-blue-500':'bg-green-500'}`}>{u.name[0]}</div>
                                                <div><p className="font-bold">{u.name}</p><p className="text-xs text-gray-500">{u.timestamp.toLocaleTimeString('zh-TW')}</p></div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- 學員手機端 ---
        function StudentView({ workshop, action, userId }) {
            const [name, setName] = useState('');
            const [fb, setFb] = useState('');
            const [ok, setOk] = useState(false);
            const [loading, setLoading] = useState(false);

            const sub = async (e) => {
                e.preventDefault(); if(!name.trim()) return;
                setLoading(true);
                try {
                    await addDoc(collection(db,'attendance_logs'), {
                        workshop, name:name.trim(), type:action, feedback:action==='signout'?fb.trim():'', timestamp:serverTimestamp(), userId:userId||'anon'
                    });
                    setOk(true);
                } catch(e){console.error(e);alert('連線錯誤');} finally{setLoading(false);}
            };

            if(ok) return (
                <div className="min-h-screen bg-green-50 flex items-center justify-center p-6 text-center">
                    <div className="bg-white p-8 rounded-2xl shadow-lg space-y-4 max-w-md w-full">
                        <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto"><Icons.CheckCircle2 className="w-10 h-10 text-green-600"/></div>
                        <h2 className="text-2xl font-bold">{action==='signin'?'簽到':'簽退'}成功</h2>
                        <p className="text-gray-600">已完成 <strong>{workshop}</strong> 登記</p>
                        <button onClick={()=>window.location.reload()} className="mt-6 text-green-600 hover:underline text-sm">再次填寫</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-100 py-12 px-4 flex flex-col justify-center">
                    <div className="max-w-md w-full mx-auto bg-white rounded-xl shadow overflow-hidden">
                        <div className={`h-3 w-full ${action==='signin'?'bg-blue-600':'bg-green-600'}`}></div>
                        <div className="p-8">
                            <div className="text-center mb-8">
                                <h2 className="text-2xl font-bold">{action==='signin'?'學員簽到':'學員簽退'}</h2>
                                <div className="mt-2 inline-block px-3 py-1 bg-gray-100 rounded-full text-sm text-gray-600">{workshop}</div>
                            </div>
                            <form onSubmit={sub} className="space-y-6">
                                <div><label className="block text-sm font-medium mb-1">姓名 <span className="text-red-500">*</span></label><input required value={name} onChange={e=>setName(e.target.value)} className="w-full px-3 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="輸入姓名"/></div>
                                {action==='signout' && <div><label className="block text-sm font-medium mb-1">心得回饋</label><textarea rows="4" value={fb} onChange={e=>setFb(e.target.value)} className="w-full px-3 py-3 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none" placeholder="分享您的收穫..."/></div>}
                                <button disabled={loading} className={`w-full py-3 rounded-lg text-white font-medium ${action==='signin'?'bg-blue-600 hover:bg-blue-700':'bg-green-600 hover:bg-green-700'}`}>{loading?'處理中...':(action==='signin'?'確認簽到':'確認簽退')}</button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>